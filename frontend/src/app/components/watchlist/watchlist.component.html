<div class="watchlist-container">
    <div class="header">
        <h1>Minha Watchlist</h1>
        <p>Acompanhe o preço das cartas que você quer comprar.</p>

        <button mat-flat-button color="accent" (click)="toggleImportPanel()" class="import-btn">
            <mat-icon>playlist_add</mat-icon> {{ isImporting ? 'Fechar Importação' : 'Importar Lista' }}
        </button>
    </div>

    <!-- Import Panel -->
    <div *ngIf="isImporting" class="import-panel">
        <textarea [(ngModel)]="importText"
            placeholder="Cole sua lista aqui...&#10;Exemplo:&#10;1 Black Lotus&#10;4 Sol Ring" rows="6"></textarea>
        <div class="import-actions">
            <button mat-raised-button color="primary" (click)="processImport()"
                [disabled]="!importText.trim() || isProcessingImport">
                <mat-icon>cloud_upload</mat-icon> Processar Lista
            </button>
        </div>
    </div>

    @if (watchlist.length > 0) {
    <div class="table-wrapper mat-elevation-z8">
        <table mat-table [dataSource]="watchlist">

            <!-- Image Column -->
            <ng-container matColumnDef="image">
                <th mat-header-cell *matHeaderCellDef> Carta </th>
                <td mat-cell *matCellDef="let item" class="image-cell">
                    <div class="image-wrapper" (click)="openVersionSwap(item)" matTooltip="Clique para trocar a versão">
                        <img [src]="item.card.imageUrl" class="card-thumb" alt="art">
                        <img [src]="item.card.imageUrl" class="card-zoom" alt="art-zoom">
                    </div>
                </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef> Nome </th>
                <td mat-cell *matCellDef="let item">
                    <a [routerLink]="['/card', item.card.id]" class="card-link">
                        {{ item.card.name }}
                    </a>
                    <div class="subtitle">{{ item.card.setName }}</div>
                </td>
            </ng-container>

            <!-- Set Column (Hidden on mobile) -->
            <ng-container matColumnDef="set">
                <th mat-header-cell *matHeaderCellDef class="hide-mobile"> Tag </th>
                <td mat-cell *matCellDef="let item" class="hide-mobile">
                    <span class="tag-badge" *ngIf="item.tag">{{ item.tag }}</span>
                    <span class="no-data" *ngIf="!item.tag">-</span>
                </td>
            </ng-container>

            <!-- Price Column -->
            <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef> Preço Atual </th>
                <td mat-cell *matCellDef="let item" class="price-cell">
                    ${{ item.card.priceUsd}}
                </td>
            </ng-container>

            <!-- Target Price Column -->
            <ng-container matColumnDef="target">
                <th mat-header-cell *matHeaderCellDef> Alvo </th>
                <td mat-cell *matCellDef="let item" class="target-cell">
                    <span *ngIf="item.targetPrice" [class.hit]="item.card.priceUsd <= item.targetPrice">
                        ${{ item.targetPrice }}
                        <mat-icon *ngIf="item.card.priceUsd <= item.targetPrice"
                            class="alert-icon">notifications_active</mat-icon>
                    </span>
                    <span class="no-data" *ngIf="!item.targetPrice">-</span>
                </td>
            </ng-container>

            <!-- Notes Column -->
            <ng-container matColumnDef="notes">
                <th mat-header-cell *matHeaderCellDef class="hide-mobile"> Notas </th>
                <td mat-cell *matCellDef="let item" class="notes-cell hide-mobile">
                    {{ item.notes || '-' }}
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Ações </th>
                <td mat-cell *matCellDef="let item" class="actions-cell">
                    <button mat-icon-button class="edit-btn" (click)="editItem(item)" matTooltip="Editar">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="removeItem(item.id)" matTooltip="Remover">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
    </div>
    } @else {
    <div class="empty-state">
        <mat-icon>favorite_border</mat-icon>
        <h3>Sua watchlist está vazia.</h3>
        <p>Vá até uma carta e clique em "Adicionar à Watchlist".</p>
        <a routerLink="/" mat-raised-button color="primary">Explorar Cartas</a>
    </div>
    }
</div>