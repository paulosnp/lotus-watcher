<div class="main-layout">

  <nav class="navbar" *ngIf="!isHomePage && !isAuthPage">

    <!-- 1. Busca Central (Agora contém a Logo) -->
    <div class="nav-search-box">
      <app-search [isCompact]="true" [customPlaceholder]="('HOME.SEARCH_PLACEHOLDER' | translate)"></app-search>
    </div>

    <!-- 2. Botões da Direita (Sets + Random) -->
    <div class="nav-actions">
      <!-- Desktop Actions Wrapper -->
      <div class="desktop-actions">
        <!-- Sets -->
        <a routerLink="/sets" class="nav-btn" title="{{ 'MENU.SETS' | translate }}">
          <mat-icon>style</mat-icon>
          <span>{{ 'MENU.SETS' | translate }}</span>
        </a>

        <!-- Random -->
        <button class="nav-btn" (click)="onRandomCard()" [disabled]="isLoadingRandom"
          title="{{ 'MENU.RANDOM' | translate }}">
          <mat-icon [class.spin]="isLoadingRandom">shuffle</mat-icon>
          <span>{{ 'MENU.RANDOM' | translate }}</span>
        </button>

        <!-- Notification Bell -->
        @if (isLoggedIn) {
        <div class="notification-wrapper">
          <button class="nav-btn notification-btn" (click)="toggleNotifications()" title="Notificações">
            <mat-icon>notifications</mat-icon>
            @if ((unreadCount$ | async); as count) {
            @if (count > 0) {
            <span class="badge">{{ count }}</span>
            }
            }
          </button>

          @if (isNotificationsOpen) {
          <div class="dropdown-menu notification-dropdown">
            <div class="dropdown-header">
              <span>{{ 'NOTIF.HEADER' | translate }}</span>
              <span class="count">{{ (unreadCount$ | async) || 0 }} {{ 'NOTIF.UNREAD' | translate }}</span>
            </div>

            <div class="notification-list">
              @for (notification of notifications$ | async; track notification.id) {
              <div class="notification-item" [class.unread]="!notification.isRead"
                (click)="markAsRead(notification.id)">
                <div class="notif-icon">
                  <mat-icon>{{ notification.type === 'PRICE_ALERT' ? 'trending_down' : 'info' }}</mat-icon>
                </div>
                <div class="notif-content">
                  <span class="notif-title">{{ notification.title }}</span>
                  <span class="notif-msg">{{ notification.message }}</span>
                  <span class="notif-time">{{ notification.createdAt | date:'short' }}</span>
                </div>
                @if (!notification.isRead) {
                <div class="unread-dot"></div>
                }
              </div>
              } @empty {
              <div class="empty-notif">
                <mat-icon>notifications_off</mat-icon>
                <p>{{ 'NOTIF.EMPTY' | translate }}</p>
              </div>
              }
            </div>
          </div>
          }
        </div>
        }
      </div>

      <!-- Menu Hamburger / Avatar Trigger -->
      <div class="header-menu-wrapper">
        <button class="nav-btn menu-toggle" (click)="toggleMenu()">
          <!-- Logged In: Show Avatar -->
          <ng-container *ngIf="isLoggedIn; else guestMenu">
            <div class="avatar-trigger">
              <img [src]="userAvatar || '/assets/default-avatar.png'" class="user-avatar" alt="Avatar">
            </div>
          </ng-container>

          <!-- Guest: Show Hamburger -->
          <ng-template #guestMenu>
            <mat-icon>{{ isMenuOpen ? 'close' : 'menu' }}</mat-icon>
          </ng-template>
        </button>

        @if (isMenuOpen) {
        <div class="dropdown-menu main-dropdown">

          <!-- MOBILE ONLY ITEMS -->
          <div class="mobile-menu-items">
            <!-- Mobile Notifications Link -->
            @if (isLoggedIn) {
            <div class="menu-item" (click)="toggleNotifications(true)">
              <mat-icon>notifications</mat-icon>
              Notificações
              @if ((unreadCount$ | async); as count) {
              @if (count > 0) { <span class="mobile-badge">{{ count }}</span> }
              }
            </div>

            @if (isNotificationsOpen) {
            <div class="mobile-notifications-list">
              @for (notification of notifications$ | async; track notification.id) {
              <div class="notification-item" [class.unread]="!notification.isRead"
                (click)="markAsRead(notification.id)">
                <div class="notif-content-mobile">
                  <span class="title">{{ notification.title }}</span>
                  <span class="msg">{{ notification.message }}</span>
                </div>
                @if (!notification.isRead) { <div class="dot"></div> }
              </div>
              } @empty {
              <div class="empty">Nenhuma notificação.</div>
              }
            </div>
            }
            }

            <a routerLink="/sets" class="menu-item"><mat-icon>style</mat-icon> {{ 'MENU.SETS' | translate }}</a>
            <button (click)="onRandomCard()" class="menu-item"><mat-icon>shuffle</mat-icon> {{ 'MENU.RANDOM' | translate
              }}</button>
            <div class="menu-divider"></div>
          </div>

          <!-- Language Toggle (Visible to All) -->
          <button class="menu-item" (click)="toggleLanguage()">
            <mat-icon>language</mat-icon>
            {{ currentLang() === 'pt' ? 'English' : 'Português' }}
          </button>
          <div class="menu-divider"></div>

          @if (!isLoggedIn) {
          <a routerLink="/login" class="menu-item"><mat-icon>login</mat-icon> {{ 'MENU.LOGIN' | translate }}</a>
          <a routerLink="/register" class="menu-item"><mat-icon>person_add</mat-icon> {{ 'MENU.REGISTER' | translate
            }}</a>
          }

          @if (isLoggedIn) {
          <a routerLink="/profile" class="menu-item"><mat-icon>account_circle</mat-icon> {{ 'MENU.PROFILE' | translate
            }}</a>

          @if (isAdmin) {
          <a routerLink="/admin" class="menu-item admin-link"><mat-icon>security</mat-icon> {{ 'MENU.ADMIN' | translate
            }}</a>
          }

          <a routerLink="/watchlist" class="menu-item"><mat-icon>bookmarks</mat-icon> {{ 'MENU.WATCHLIST' | translate
            }}</a>
          <div class="menu-divider"></div>
          <button (click)="logout()" class="menu-item logout"><mat-icon>logout</mat-icon> {{ 'MENU.LOGOUT' | translate
            }}</button>
          }
        </div>
        }
      </div>
    </div>
  </nav>

  <main class="content-area">
    <router-outlet></router-outlet>
    <app-footer></app-footer>
  </main>

</div>