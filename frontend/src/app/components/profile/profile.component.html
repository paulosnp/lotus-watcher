<div class="profile-container">

    <!-- Profile Header (Preview) -->
    <div class="profile-header">
        <div class="header-avatar-wrapper">
            <img [src]="selectedAvatar || '/assets/default-avatar.png'" class="header-avatar" alt="Avatar Atual"
                onerror="this.src='/assets/default-avatar.png'">

            <!-- BUTTON: Upload Icon overlaps avatar -->
            <div class="header-edit-icon" (click)="triggerFileInput()"
                matTooltip="{{ 'PROFILE.UPLOAD_TOOLTIP' | translate }}">
                <mat-icon [class.spin]="isUploading">{{ isUploading ? 'sync' : 'cloud_upload' }}</mat-icon>
            </div>
            <input type="file" id="fileUpload" (change)="onFileSelected($event)" accept="image/*" hidden>
        </div>

        <div class="header-info">
            <!-- Show current name (live preview if editing) -->
            <h1>{{ (isEditingName ? newName : user?.name) || ('PROFILE.DEFAULT_USER' | translate) }}</h1>
            <p>{{ user?.email }}</p>
            <span class="role-badge" *ngIf="user?.role === 'ADMIN'">ADMIN</span>
        </div>
    </div>

    <mat-card class="profile-card">
        <h3>{{ 'PROFILE.CHOOSE_AVATAR' | translate }}</h3>

        <div class="avatar-section">
            <div class="avatar-grid">
                <div *ngFor="let avatar of avatars" class="avatar-item" [class.selected]="selectedAvatar === avatar"
                    (click)="selectAvatar(avatar)">
                    <img [src]="avatar" alt="Avatar">
                </div>
            </div>
        </div>

        <mat-divider style="margin: 30px 0;"></mat-divider>

        <!-- Informações Pessoais -->
        <div class="section-header">
            <h3>{{ 'PROFILE.PERSONAL_INFO' | translate }}</h3>
            <button mat-icon-button (click)="toggleEditName()"
                matTooltip="{{ 'PROFILE.EDIT_NAME_TOOLTIP' | translate }}">
                <mat-icon>{{ isEditingName ? 'close' : 'edit' }}</mat-icon>
            </button>
        </div>

        <div class="info-row">
            <div class="info-group">
                <label>{{ 'PROFILE.EMAIL_LABEL' | translate }}</label>
                <span class="display-value locked"><mat-icon>lock</mat-icon> {{ user?.email }}</span>
            </div>

            <div class="info-group">
                <label>{{ 'PROFILE.DISPLAY_NAME_LABEL' | translate }}</label>
                <span *ngIf="!isEditingName" class="display-value highlight">{{ user?.name || ('PROFILE.NO_NAME' |
                    translate) }}</span>

                <div *ngIf="isEditingName" class="edit-name-inline">
                    <mat-form-field appearance="outline" class="full-width">
                        <!-- Input override handled globally now, but keeping class just in case -->
                        <input matInput [(ngModel)]="newName"
                            placeholder="{{ 'PROFILE.NICK_PLACEHOLDER' | translate }}">
                    </mat-form-field>

                    <button mat-mini-fab class="action-btn save-btn" (click)="saveName()" [disabled]="isLoading"
                        matTooltip="{{ 'PROFILE.SAVE_NAME_TOOLTIP' | translate }}">
                        <mat-icon>check</mat-icon>
                    </button>

                    <button mat-mini-fab color="warn" class="action-btn cancel-btn" (click)="toggleEditName()"
                        matTooltip="{{ 'PROFILE.CANCEL_TOOLTIP' | translate }}">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>
            </div>
        </div>

        <mat-divider style="margin: 30px 0;"></mat-divider>

        <!-- Segurança -->
        <div class="section-header">
            <h3>{{ 'PROFILE.SECURITY_SECTION' | translate }}</h3>
            <button mat-stroked-button (click)="toggleChangePassword()" *ngIf="!isChangingPassword"
                class="change-pass-btn">
                <mat-icon>vpn_key</mat-icon> {{ 'PROFILE.CHANGE_PASS_BTN' | translate }}
            </button>
            <button mat-icon-button (click)="toggleChangePassword()" *ngIf="isChangingPassword">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <div *ngIf="isChangingPassword" class="password-form-container">
            <p class="hint">{{ 'PROFILE.CHANGE_PASS_HINT' | translate }}</p>

            <div class="custom-input-group">
                <label>{{ 'PROFILE.CURRENT_PASS_LABEL' | translate }}</label>
                <input type="password" [(ngModel)]="oldPassword" class="steam-input"
                    placeholder="{{ 'PROFILE.CURRENT_PASS_PLACEHOLDER' | translate }}">
            </div>

            <div class="custom-input-group">
                <label>{{ 'PROFILE.NEW_PASS_LABEL' | translate }}</label>
                <input type="password" [(ngModel)]="password" class="steam-input"
                    placeholder="{{ 'PROFILE.NEW_PASS_PLACEHOLDER' | translate }}">
            </div>

            <div class="custom-input-group">
                <label>{{ 'PROFILE.CONFIRM_PASS_LABEL' | translate }}</label>
                <input type="password" [(ngModel)]="confirmPassword" class="steam-input"
                    placeholder="{{ 'PROFILE.CONFIRM_PASS_PLACEHOLDER' | translate }}">
            </div>

            <div class="actions" style="margin-top: 16px;">
                <button mat-raised-button color="primary" (click)="savePassword()" [disabled]="isLoading">
                    {{ 'PROFILE.CONFIRM_PASS_BTN' | translate }}
                </button>
            </div>
        </div>

        <div class="actions" *ngIf="!isEditingName && !isChangingPassword">
            <!-- Global Action mainly for Avatar now -->
            <button mat-raised-button color="primary" (click)="saveAvatar()"
                [disabled]="isLoading || selectedAvatar === user?.avatar">
                <mat-icon>save</mat-icon> {{ 'PROFILE.SAVE_AVATAR_BTN' | translate }}
            </button>
        </div>
    </mat-card>
</div>