<div class="dashboard-container">

  <!-- MENU HAMBURGUER RESTAURADO (FIXED TOP-RIGHT) -->
  @if (!isSearching) {
  <div class="home-menu-wrapper">

    <div class="menu-controls" style="display: flex; gap: 10px;">

      <!-- Notification Bell -->
      @if (isLoggedIn) {
      <div class="notification-wrapper">
        <button class="menu-btn notification-btn" (click)="toggleNotifications()" title="Notificações">
          <mat-icon>notifications</mat-icon>
          @if ((unreadCount$ | async); as count) {
          @if (count > 0) {
          <span class="badge">{{ count }}</span>
          }
          }
        </button>

        @if (isNotificationsOpen) {
        <div class="dropdown-menu notification-dropdown">
          <div class="dropdown-header">
            <span>{{ 'NOTIF.HEADER' | translate }}</span>
            <span class="count">{{ (unreadCount$ | async) || 0 }} {{ 'NOTIF.UNREAD' | translate }}</span>
          </div>

          <div class="notification-list">
            @for (notification of notifications$ | async; track notification.id) {
            <div class="notification-item" [class.unread]="!notification.isRead" (click)="markAsRead(notification.id)">
              <div class="notif-icon">
                <mat-icon>{{ notification.type === 'PRICE_ALERT' ? 'trending_down' : 'info' }}</mat-icon>
              </div>
              <div class="notif-content">
                <span class="notif-title">{{ notification.title }}</span>
                <span class="notif-msg">{{ notification.message }}</span>
                <span class="notif-time">{{ notification.createdAt | date:'short' }}</span>
              </div>

              <button class="delete-btn" (click)="deleteNotification(notification.id, $event)"
                title="{{ 'NOTIF.DELETE' | translate }}">
                <mat-icon>delete</mat-icon>
              </button>

              @if (!notification.isRead) {
              <div class="unread-dot"></div>
              }
            </div>
            } @empty {
            <div class="empty-notif">
              <mat-icon>notifications_off</mat-icon>
              <p>{{ 'NOTIF.EMPTY' | translate }}</p>
            </div>
            }
          </div>
        </div>
        }
      </div>
      }

      <!-- ONE BUTTON to rule them all -->
      <button class="menu-btn" (click)="toggleMenu()">
        <!-- Logged In: Show Avatar -->
        <ng-container *ngIf="isLoggedIn; else guestIcon">
          <img [src]="userAvatar || '/assets/default-avatar.png'" class="user-avatar" alt="Avatar"
            style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #66c0f4; object-fit: cover;">
        </ng-container>

        <!-- Guest: Show Menu Icon -->
        <ng-template #guestIcon>
          <mat-icon>{{ isMenuOpen ? 'close' : 'menu' }}</mat-icon>
        </ng-template>
      </button>
    </div>

    @if (isMenuOpen) {
    <div class="dropdown-menu">
      <button class="menu-item" (click)="toggleLanguage()">
        <mat-icon>language</mat-icon>
        {{ currentLang() === 'pt' ? 'English' : 'Português' }}
      </button>
      <div class="menu-divider"></div>

      @if (!isLoggedIn) {
      <a routerLink="/login" class="menu-item"><mat-icon>login</mat-icon> {{ 'MENU.LOGIN' | translate }}</a>
      <a routerLink="/register" class="menu-item"><mat-icon>person_add</mat-icon> {{ 'MENU.REGISTER' | translate }}</a>
      }

      @if (isLoggedIn) {
      <a routerLink="/profile" class="menu-item"><mat-icon>account_circle</mat-icon> {{ 'MENU.PROFILE' | translate
        }}</a>
      @if (isAdmin) {
      <a routerLink="/admin" class="menu-item"><mat-icon>security</mat-icon> {{ 'MENU.ADMIN' | translate }}</a>
      }
      <a routerLink="/watchlist" class="menu-item"><mat-icon>bookmarks</mat-icon> {{ 'MENU.WATCHLIST' | translate }}</a>
      <div class="menu-divider"></div>
      <button (click)="logout()" class="menu-item logout"><mat-icon>logout</mat-icon> {{ 'MENU.LOGOUT' | translate
        }}</button>
      }
    </div>
    }
  </div>
  }



  @if (!isSearching) {
  <section class="hero-section">
    <div class="hero-content">
      <h1>{{ 'HOME.WELCOME' | translate }} <br class="mobile-break"> <img src="assets/logo.svg" alt="Logo"
          class="hero-logo"> <span class="highlight">Lotus Watcher</span></h1>
      <p>{{ 'HOME.SUBTITLE' | translate }}</p>

      <div class="hero-search-wrapper">
        <app-search [isCompact]="true" [customPlaceholder]="('HOME.SEARCH_PLACEHOLDER' | translate)"></app-search>



        <a routerLink="/sets" class="action-btn-home" title="{{ 'MENU.SETS' | translate }}">
          <mat-icon>style</mat-icon>
        </a>

        <button class="action-btn-home" (click)="onRandomCard()" title="{{ 'MENU.RANDOM' | translate }}">
          <mat-icon>shuffle</mat-icon>
        </button>
      </div>

      <!-- FILTER PANEL -->
      <div class="filter-panel" *ngIf="showFilters">
        <div class="filter-group">
          <label>{{ 'FILTER.COLORS' | translate }}</label>
          <div class="color-options">
            <button class="mana-btn w" [class.active]="filterState.colors.w"
              (click)="updateFilter('colors', 'w')"></button>
            <button class="mana-btn u" [class.active]="filterState.colors.u"
              (click)="updateFilter('colors', 'u')"></button>
            <button class="mana-btn b" [class.active]="filterState.colors.b"
              (click)="updateFilter('colors', 'b')"></button>
            <button class="mana-btn r" [class.active]="filterState.colors.r"
              (click)="updateFilter('colors', 'r')"></button>
            <button class="mana-btn g" [class.active]="filterState.colors.g"
              (click)="updateFilter('colors', 'g')"></button>
            <button class="mana-btn c" [class.active]="filterState.colors.c"
              (click)="updateFilter('colors', 'c')"></button>
          </div>
        </div>

        <div class="filter-group">
          <label>{{ 'FILTER.RARITY' | translate }}</label>
          <div class="chip-options">
            <button class="chip" [class.active]="filterState.rarities.common"
              (click)="updateFilter('rarities', 'common')">{{ 'FILTER.COMMON' | translate }}</button>
            <button class="chip" [class.active]="filterState.rarities.uncommon"
              (click)="updateFilter('rarities', 'uncommon')">{{ 'FILTER.UNCOMMON' | translate }}</button>
            <button class="chip" [class.active]="filterState.rarities.rare"
              (click)="updateFilter('rarities', 'rare')">{{ 'FILTER.RARE' | translate }}</button>
            <button class="chip" [class.active]="filterState.rarities.mythic"
              (click)="updateFilter('rarities', 'mythic')">{{ 'FILTER.MYTHIC' | translate }}</button>
          </div>
        </div>

        <div class="filter-group">
          <label>{{ 'FILTER.TYPE' | translate }}</label>
          <div class="chip-options wrap">
            <button class="chip" [class.active]="filterState.types.creature"
              (click)="updateFilter('types', 'creature')">{{ 'FILTER.CREATURE' | translate }}</button>
            <button class="chip" [class.active]="filterState.types.instant"
              (click)="updateFilter('types', 'instant')">{{ 'FILTER.INSTANT' | translate }}</button>
            <button class="chip" [class.active]="filterState.types.sorcery"
              (click)="updateFilter('types', 'sorcery')">{{ 'FILTER.SORCERY' | translate }}</button>
            <button class="chip" [class.active]="filterState.types.enchantment"
              (click)="updateFilter('types', 'enchantment')">{{ 'FILTER.ENCHANTMENT' | translate }}</button>
            <button class="chip" [class.active]="filterState.types.artifact"
              (click)="updateFilter('types', 'artifact')">{{ 'FILTER.ARTIFACT' | translate }}</button>
            <button class="chip" [class.active]="filterState.types.planeswalker"
              (click)="updateFilter('types', 'planeswalker')">{{ 'FILTER.PLANESWALKER' | translate }}</button>
            <button class="chip" [class.active]="filterState.types.land" (click)="updateFilter('types', 'land')">{{
              'FILTER.LAND' | translate }}</button>
          </div>
        </div>

        <div class="filter-actions">
          <button class="apply-btn" (click)="applyFilters()">
            <mat-icon>search</mat-icon> {{ 'FILTER.APPLY' | translate }}
          </button>
        </div>
      </div>

    </div>
  </section>
  }

  @if (isSearching) {
  <section class="market-overview search-results">
    <div class="market-list" style="width: 100%">
      <div class="list-header">
        <button class="back-btn" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-icon>search</mat-icon>
        <h2>
          <!-- Show specific title if it's a complex query -->
          @if (searchQuery.includes(':')) {
          {{ 'MARKET.ADVANCED_SEARCH_RESULTS' | translate }}
          } @else {
          {{ 'MARKET.SEARCH_RESULTS' | translate }} "{{ searchQuery }}"
          }
        </h2>
      </div>

      <div class="cards-grid">
        @for (card of searchResults; track card.id) {
        <div class="mini-card" (click)="irParaDetalhes(card.id)">
          <div class="card-thumb">
            <img [src]="card.imageUrl" alt="{{ card.name }}"
              (error)="card.imageUrl = 'https://i.imgur.com/LdOBU1I.jpg'">
          </div>
          <div class="card-info">
            <span class="name">{{ card.name }}</span>
            <span class="set">{{ card.setName }}</span>
          </div>
          <div class="price-block">
            <span class="current-price">${{ card.priceUsd }}</span>
          </div>
        </div>
        } @empty {
        @if(isLoading) {
        <p class="empty-msg">{{ 'MARKET.EMPTY' | translate }}</p>
        } @else {
        <p class="empty-msg">{{ 'MARKET.NO_RESULTS' | translate }}</p>
        }
        }
      </div>
    </div>
  </section>
  } @else {
  <section class="market-overview">

    <div class="market-list winners">
      <div class="list-header">
        <mat-icon>trending_up</mat-icon>
        <h2>{{ 'MARKET.RISERS' | translate }}</h2>
      </div>

      <div class="cards-grid">
        @for (card of topRisers; track card.id) {
        <div class="mini-card" (click)="irParaDetalhes(card.id)">
          <div class="card-thumb">
            <img [src]="card.imageUrl" alt="{{ card.name }}"
              (error)="card.imageUrl = 'https://i.imgur.com/LdOBU1I.jpg'">
          </div>
          <div class="card-info">
            <span class="name">{{ card.name }}</span>
            <span class="set">{{ card.setName }}</span>
          </div>
          <div class="price-block">
            <span class="price up">+{{ card.priceChangePercentage | number:'1.1-2' }}%</span>
            <span class="current-price">${{ card.priceUsd }}</span>
          </div>
        </div>
        } @empty {
        <p class="empty-msg">{{ 'MARKET.EMPTY' | translate }}</p>
        }
      </div>
    </div>

    <div class="market-list losers">
      <div class="list-header">
        <mat-icon>trending_down</mat-icon>
        <h2>{{ 'MARKET.FALLERS' | translate }}</h2>
      </div>

      <div class="cards-grid">
        @for (card of topFallers; track card.id) {
        <div class="mini-card" (click)="irParaDetalhes(card.id)">
          <div class="card-thumb">
            <img [src]="card.imageUrl" alt="{{ card.name }}"
              (error)="card.imageUrl = 'https://i.imgur.com/LdOBU1I.jpg'">
          </div>
          <div class="card-info">
            <span class="name">{{ card.name }}</span>
            <span class="set">{{ card.setName }}</span>
          </div>
          <div class="price-block">
            <span class="price down">{{ card.priceChangePercentage | number:'1.1-2' }}%</span>
            <span class="current-price">${{ card.priceUsd }}</span>
          </div>
        </div>
        } @empty {
        <p class="empty-msg">Carregando dados do mercado...</p>
        }
      </div>
    </div>

  </section>
  }

</div>